version: 2.1

jobs:
  pypi_publish_example:
    docker:
      - image: cimg/python:3.13.9
    parameters:
      pypi-env:
        description: "PYPI_ENV value (staging or production)"
        type: string
      domain:
        description: "Override repository domain (staging only)"
        type: string
        default: ""
      oidc-audience:
        description: "Override OIDC audience (staging only)"
        type: string
        default: ""
    steps:
      - checkout
      - run:
          name: install build and publish tools
          command: |
            python -m venv .venv
            . .venv/bin/activate
            python -m pip install --upgrade pip
            python -m pip install "uv_build>=0.9.21,<0.10.0" twine
      - run:
          name: build distributions
          command: |
            . .venv/bin/activate
            export PYPI_ENV="<<parameters.pypi-env>>"
            cd pypi && ./build.sh
      - run:
          name: publish to PyPI
          command: |
            . .venv/bin/activate
            export PYPI_ENV="<<parameters.pypi-env>>"
            export PYPI_DOMAIN="<<parameters.domain>>"
            export PYPI_OIDC_AUDIENCE="<<parameters.oidc-audience>>"
            cd pypi && ./publish.sh
      - store_artifacts:
          path: pypi/dist
          destination: pypi-distributions

workflows:
  pypi_publish_production:
    jobs:
      - pypi_publish_example:
          name: PyPI Publish Production
          pypi-env: production
          filters:
            branches:
              only:
                - main

  pypi_publish_staging:
    jobs:
      - pypi_publish_example:
          name: PyPI Publish Staging
          pypi-env: staging
          domain: skozl1-ip-108-161-113-80.tunnelmole.net
          oidc-audience: pypi
          filters:
            branches:
              ignore:
                - main
