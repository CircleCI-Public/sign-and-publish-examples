version: 2.1

commands:
  set-pypi-env:
    description: "Set PYPI_ENV environment variable"
    parameters:
      pypi-env:
        description: "PYPI_ENV value (staging, production, or local)"
        type: string
    steps:
      - run:
          name: set PYPI_ENV
          command: |
            echo 'export PYPI_ENV="<<parameters.pypi-env>>"' >> "$BASH_ENV"

  generate-oidc-token:
    description: "Generate OIDC token for PyPI Trusted Publishing"
    steps:
      - run:
          name: generate OIDC token
          command: |
            echo "export OIDC_TOKEN='$(circleci run oidc get --root-issuer --claims '{"aud":"pypi"}')'" >> "$BASH_ENV"

jobs:
  pypi_publish_example:
    docker:
      - image: cimg/python:3.13.9
    parameters:
      pypi-env:
        description: "PYPI_ENV value (staging, production, or local)"
        type: string
      staging-pypi-url:
        description: "Staging PyPI repository URL"
        type: string
        default: "https://test.pypi.org/legacy/"
      production-pypi-url:
        description: "Production PyPI repository URL"
        type: string
        default: "https://upload.pypi.org/legacy/"
    steps:
      - checkout
      - set-pypi-env:
          pypi-env: <<parameters.pypi-env>>
      - generate-oidc-token
      - run:
          name: install build and publish tools
          command: |
            python -m venv .venv
            . .venv/bin/activate
            python -m pip install --upgrade pip
            python -m pip install "uv_build>=0.9.21,<0.10.0" twine
      - run:
          name: build distributions
          command: |
            . .venv/bin/activate
            cd pypi && ./build.sh
      - run:
          name: publish to PyPI
          command: |
            . .venv/bin/activate
            export STAGING_PYPI_URL="<<parameters.staging-pypi-url>>"
            export PRODUCTION_PYPI_URL="<<parameters.production-pypi-url>>"
            cd pypi && ./publish.sh
      - store_artifacts:
          path: pypi/dist
          destination: pypi-distributions

workflows:
  pypi_publish_production:
    jobs:
      - pypi_publish_example:
          name: PyPI Publish Production
          pypi-env: production
          filters:
            branches:
              only:
                - main

  pypi_publish_staging:
    jobs:
      - pypi_publish_example:
          name: PyPI Publish Staging
          pypi-env: staging
          staging-pypi-url: "https://hp48po-ip-108-161-113-80.tunnelmole.net/legacy/"
          filters:
            branches:
              ignore:
                - main
